<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JC INV PORTFOLIO</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#14141f;--border:#2a2a3a;--text:#e0e0e0;--dim:#888;--green:#00e676;--red:#ff5252;--orange:#f7931a;--blue:#64b5f6;--header-bg:#1a1a2e}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;padding:12px;max-width:1200px;margin:0 auto;line-height:1.5}
h1{color:#fff;font-size:1.4rem;margin-bottom:4px;font-weight:700;letter-spacing:2px}
h2{color:#fff;font-size:1rem;margin:20px 0 10px;border-bottom:1px solid var(--border);padding-bottom:4px;font-weight:600}
.sub{color:var(--dim);font-size:.75rem}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px}
.icon{filter:brightness(0) invert(1);width:14px;height:14px;vertical-align:middle;margin-right:4px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.stat .label{color:var(--dim);font-size:.65rem;text-transform:uppercase;letter-spacing:1px}
.stat .value{font-size:1.1rem;font-weight:700;margin-top:2px}
.green{color:var(--green)}.red{color:var(--red)}.dim{color:var(--dim)}

/* Portfolio Accordion */
.portfolio-list{display:flex;flex-direction:column;gap:4px}
.coin-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.coin-row{display:grid;grid-template-columns:1.6fr 1fr 1fr 1fr 1fr 1fr;align-items:center;padding:8px 10px;cursor:pointer;user-select:none;gap:2px;transition:background .15s}
.coin-row:hover{background:rgba(255,255,255,.03)}
.coin-symbol{font-weight:700;font-size:.75rem}
.coin-name{color:var(--dim);font-size:.6rem}
.coin-val{font-size:.65rem;text-align:right;white-space:nowrap}
.coin-arrow{color:var(--dim);font-size:.7rem;transition:transform .25s;margin-left:6px}
.coin-card.open .coin-arrow{transform:rotate(180deg)}

/* Accordion details */
.coin-details{max-height:0;overflow:hidden;transition:max-height .35s ease;border-top:0 solid var(--border)}
.coin-card.open .coin-details{max-height:600px;border-top-width:1px}
.coin-details-inner{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
.detail-section{background:rgba(255,255,255,.02);border-radius:8px;padding:12px}
.detail-section h4{font-size:.7rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.detail-section h4.orange{color:var(--orange)}
.detail-section h4.blue{color:var(--blue)}
.detail-section p{font-size:.7rem;color:var(--dim);line-height:1.5}
.detail-links{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px}
.detail-links a{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:var(--header-bg);border:1px solid var(--border);border-radius:6px;color:var(--blue);text-decoration:none;font-size:.7rem;transition:background .15s}
.detail-links a:hover{background:rgba(100,181,246,.1)}
.community-stat{display:flex;gap:12px;font-size:.7rem}
.community-stat span{color:var(--dim)}
.community-stat strong{color:var(--text)}

/* Sold coins table */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
.overflow-x{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{background:var(--header-bg);color:#fff;text-align:left;padding:8px 6px;position:sticky;top:0}
td{padding:7px 6px;border-bottom:1px solid var(--border)}
tr:hover{background:rgba(255,255,255,.03)}
.badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.7rem;font-weight:600;text-transform:uppercase}
.badge-sold{background:rgba(255,82,82,.15);color:var(--red)}
.badge-watchlist{background:rgba(100,181,246,.15);color:var(--blue)}

/* Scanner */
.scanner-card{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;overflow:hidden}
.scanner-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;user-select:none;gap:10px}
.scanner-header:hover{background:rgba(255,255,255,.03)}
.scanner-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.scanner-symbol{font-weight:700;font-size:1.1rem;white-space:nowrap}
.scanner-narrative{color:var(--dim);font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.scanner-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.scanner-score{font-weight:700;font-size:1rem;background:var(--header-bg);padding:3px 10px;border-radius:8px}
.scanner-arrow{color:var(--dim);font-size:.8rem;transition:transform .2s}
.scanner-card.open .scanner-arrow{transform:rotate(180deg)}
.scanner-details{display:none;padding:0 16px 14px;border-top:1px solid var(--border)}
.scanner-card.open .scanner-details{display:block}
.scanner-row{display:flex;justify-content:space-between;padding:6px 0;font-size:.85rem}
.scanner-row .label{color:var(--dim)}
.scanner-row .val{font-weight:600}
.scanner-reason{margin-top:8px;padding:10px;background:rgba(255,255,255,.03);border-radius:8px;font-size:.83rem;line-height:1.5;color:var(--dim)}
/* Scanner Pagination */
.scanner-pagination{display:flex;align-items:center;justify-content:center;gap:12px;margin:12px 0 4px;user-select:none}
.scanner-pagination button{background:var(--header-bg);border:1px solid var(--border);color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.85rem;transition:background .15s}
.scanner-pagination button:hover:not(:disabled){background:rgba(100,181,246,.15)}
.scanner-pagination button:disabled{opacity:.3;cursor:default}
.scanner-pagination .page-info{color:var(--dim);font-size:.8rem}
.scanner-page{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;gap:0}
.scanner-page::-webkit-scrollbar{display:none}
.scanner-page-group{min-width:100%;scroll-snap-align:start;flex-shrink:0}
/* Lessons Dropdown */
.lessons-dropdown{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:16px;overflow:hidden}
.lessons-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;user-select:none}
.lessons-header:hover{background:rgba(255,255,255,.03)}
.lessons-arrow{color:var(--dim);font-size:.8rem;transition:transform .25s}
.lessons-dropdown.open .lessons-arrow{transform:rotate(180deg)}
.lessons-content{max-height:0;overflow:hidden;transition:max-height .4s ease}
.lessons-dropdown.open .lessons-content{max-height:2000px}
.chart-wrap{height:300px;position:relative}
.lesson{margin-bottom:12px;padding:12px;background:rgba(247,147,26,.05);border-left:3px solid var(--orange);border-radius:0 8px 8px 0}
.lesson .code{color:var(--orange);font-weight:700;margin-right:8px}
.lesson .rule{color:var(--green);font-size:.82rem;margin-top:4px}
#loading{text-align:center;padding:60px;color:var(--dim);font-size:1.2rem}

@media(max-width:700px){
  .coin-row{grid-template-columns:1.3fr 1fr 1fr 1fr 1fr;font-size:.58rem;padding:5px 6px;gap:1px}
  .coin-symbol{font-size:.62rem}
  .coin-val{font-size:.55rem}
  .hide-mobile{display:none}
  .coin-row .hide-mobile{display:none}
  .coin-details-inner{grid-template-columns:1fr}
  h1{font-size:1.3rem}
  .stat .value{font-size:1rem}
  .stat .label{font-size:.65rem}
  table{font-size:.7rem}
  td,th{padding:4px 3px}
}
</style>
</head>
<body>
<div id="loading">⏳ Loading data...</div>
<div id="app" style="display:none">

<header style="margin-bottom:20px">
<h1>JC INV PORTFOLIO</h1>
<div class="sub" id="lastUpdate"></div>
</header>

<div class="stats" id="statsGrid"></div>

<h2><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-7"/></svg>Portfolio Holdings</h2>
<div class="portfolio-list" id="portfolioList"></div>

<h2><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Portfolio Entwicklung</h2>
<div class="card chart-wrap"><canvas id="priceChart"></canvas></div>

<h2><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="M3 3l18 18M21 3L3 21"/></svg>Verkaufte Coins</h2>
<div class="card overflow-x" id="soldSection"></div>

<h2><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Watchlist</h2>
<div class="card overflow-x" id="watchlistSection"></div>

<h2><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>Scanner Ergebnisse</h2>
<div id="scannerCards"></div>

<div class="lessons-dropdown" id="lessonsDropdown" onclick="this.classList.toggle('open')">
  <div class="lessons-header">
    <h2 style="margin:0;border:none;padding:0"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>Lessons Learned <span id="lessonsCount" class="dim" style="font-size:.75rem"></span></h2>
    <span class="lessons-arrow">▼</span>
  </div>
  <div class="lessons-content" id="lessonsSection"></div>
</div>

</div>

<script>
const $ = s => document.querySelector(s);
const fmt = (n,d=2) => n!=null ? Number(n).toLocaleString('de-DE',{minimumFractionDigits:d,maximumFractionDigits:d}) : '–';
const fmtVal = n => n!=null ? '$' + Number(n).toLocaleString('de-DE',{minimumFractionDigits:0,maximumFractionDigits:0}) : '–';
const fmtPrice = n => {
  if(n==null) return '–';
  if(n < 0.01) return '$' + Number(n).toFixed(5);
  if(n < 1) return '$' + Number(n).toFixed(4);
  return '$' + Number(n).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
};
const fmtCompact = n => {
  if(!n) return '–';
  if(n>=1e9) return '$'+fmt(n/1e9,1)+'B';
  if(n>=1e6) return '$'+fmt(n/1e6,1)+'M';
  if(n>=1e3) return '$'+fmt(n/1e3,1)+'K';
  return '$'+fmt(n);
};
const pnlClass = v => v >= 0 ? 'green' : 'red';
const pnlSign = v => v >= 0 ? '+' : '';
const fmtNum = n => n ? n.toLocaleString('de-DE') : '–';

async function init() {
  let data, details;
  const base = 'https://raw.githubusercontent.com/JPSigmaflow/Milo/main/';
  const t = Date.now();
  try {
    const [r1, r2] = await Promise.all([
      fetch(base + 'data.json?t=' + t),
      fetch(base + 'coin_details.json?t=' + t)
    ]);
    data = await r1.json();
    details = await r2.json().catch(() => ({}));
  } catch(e) {
    $('#loading').textContent = '❌ Could not load data';
    return;
  }
  $('#loading').style.display = 'none';
  $('#app').style.display = 'block';

  const d = new Date(data.exported_at);
  $('#lastUpdate').textContent = `Letzte Aktualisierung: ${d.toLocaleDateString('de-DE')} ${d.toLocaleTimeString('de-DE')} UTC`;

  const active = data.holdings.filter(h => h.status === 'active');
  const sold = data.holdings.filter(h => h.status === 'sold' || (h.sold_price && h.sold_price > 0));
  const watchlist = data.holdings.filter(h => h.status === 'watchlist' && !(h.sold_price && h.sold_price > 0));

  // Get latest 24h change per symbol from price_history
  const changes = {};
  (data.price_history||[]).forEach(p => { changes[p.symbol] = p.change_24h; });

  // Stats
  let totalValue = 0, totalInvested = 0;
  active.forEach(h => {
    totalValue += h.amount * (h.current_price || 0);
    totalInvested += h.amount * h.entry_price;
  });
  const totalPnl = totalInvested > 0 ? ((totalValue - totalInvested) / totalInvested * 100) : 0;
  const totalPnlAbs = totalValue - totalInvested;

  $('#statsGrid').innerHTML = `
    <div class="stat"><div class="label">Gesamtwert (inkl. USDT)</div><div class="value">${fmtVal(data.total_with_usdt || (totalValue + (data.usdt_free||0)))}</div></div>
    <div class="stat"><div class="label">Coin-Wert</div><div class="value">${fmtVal(totalValue)}</div></div>
    <div class="stat"><div class="label">Investiert</div><div class="value">${fmtVal(totalInvested)}</div></div>
    <div class="stat"><div class="label">P&L</div><div class="value ${pnlClass(totalPnlAbs)}">${pnlSign(totalPnlAbs)}${fmtVal(totalPnlAbs)} (${pnlSign(totalPnl)}${fmt(totalPnl)}%)</div></div>
    <div class="stat"><div class="label">USDT Frei</div><div class="value">${fmtVal(data.usdt_free)}</div></div>
    <div class="stat"><div class="label">Positionen</div><div class="value">${active.length}</div></div>
  `;

  // Portfolio with accordion
  const listDiv = $('#portfolioList');
  active.sort((a,b) => (b.amount * (b.current_price||0)) - (a.amount * (a.current_price||0)));
  
  active.forEach(h => {
    const val = h.amount * (h.current_price || 0);
    const pnl = h.entry_price > 0 ? ((h.current_price - h.entry_price) / h.entry_price * 100) : 0;
    const chg = changes[h.symbol];
    const det = details[h.symbol] || {};
    
    const card = document.createElement('div');
    card.className = 'coin-card';
    
    // Links
    let linksHtml = '';
    if(det.website) linksHtml += `<a href="${det.website}" target="_blank">Website</a>`;
    if(det.github) linksHtml += `<a href="${det.github}" target="_blank">GitHub</a>`;
    if(det.twitter) linksHtml += `<a href="${det.twitter}" target="_blank">X/Twitter</a>`;
    if(det.telegram) linksHtml += `<a href="${det.telegram}" target="_blank">Telegram</a>`;
    
    // Community
    let communityHtml = '';
    if(det.community) {
      if(det.community.tg_members) communityHtml += `<span>TG: <strong>${fmtNum(det.community.tg_members)}</strong></span>`;
      if(det.community.twitter_followers) communityHtml += `<span>Twitter: <strong>${fmtNum(det.community.twitter_followers)}</strong></span>`;
    }
    if(!communityHtml) communityHtml = '<span>Keine Daten</span>';

    card.innerHTML = `
      <div class="coin-row" onclick="this.parentElement.classList.toggle('open')">
        <div>
          <span class="coin-symbol">${h.symbol}</span> <span class="coin-arrow">▼</span>
          <div class="coin-name">${h.name} · ${h.chain||''}</div>
        </div>
        <div class="coin-val">${fmtPrice(h.current_price)}</div>
        <div class="coin-val hide-mobile">${fmtPrice(h.entry_price)}</div>
        <div class="coin-val ${pnlClass(pnl)}"><strong>${pnlSign(pnl)}${fmt(pnl)}%</strong></div>
        <div class="coin-val">${fmtVal(val)}</div>
        <div class="coin-val ${chg >= 0 ? 'green' : 'red'}">${chg != null ? pnlSign(chg)+fmt(chg)+'%' : '–'}</div>
      </div>
      <div class="coin-details">
        <div class="coin-details-inner">
          <div class="detail-section">
            <h4 class="orange">HAWK Analyse</h4>
            <p>${det.hawk_summary || 'Keine Analyse verfügbar'}</p>
            ${det.hawk_score != null ? `<p style="margin-top:6px;color:var(--orange)">Score: <strong>${det.hawk_score}/100</strong></p>` : ''}
          </div>
          <div class="detail-section">
            <h4 class="blue">Nächste Meilensteine</h4>
            <p>${det.milestones || 'Keine bekannt'}</p>
          </div>
          <div class="detail-section">
            <h4 class="blue">Links</h4>
            <div class="detail-links">${linksHtml || '<span class="dim">Keine Links</span>'}</div>
          </div>
          <div class="detail-section">
            <h4 class="orange">Community</h4>
            <div class="community-stat">${communityHtml}</div>
          </div>
        </div>
      </div>
    `;
    listDiv.appendChild(card);
  });

  // Column headers for portfolio
  const headerDiv = document.createElement('div');
  headerDiv.className = 'coin-row';
  headerDiv.style.cssText = 'cursor:default;font-size:.6rem;color:var(--dim);text-transform:uppercase;letter-spacing:1px;padding:4px 10px;background:transparent';
  headerDiv.onclick = null;
  headerDiv.innerHTML = '<div>Coin</div><div class="coin-val">Preis</div><div class="coin-val hide-mobile">Entry</div><div class="coin-val">P&L%</div><div class="coin-val">Wert</div><div class="coin-val">24h</div>';
  listDiv.insertBefore(headerDiv, listDiv.firstChild);

  // Sold coins table
  const soldDiv = $('#soldSection');
  if(sold.length) {
    let html = '<table><thead><tr><th>Coin</th><th>Entry</th><th>Exit</th><th>P&L%</th><th>Kaufdatum</th><th>Verkaufsdatum</th><th>Status</th></tr></thead><tbody>';
    sold.forEach(h => {
      const exitPrice = h.sold_price || h.current_price;
      const pnl = h.entry_price > 0 && exitPrice ? ((exitPrice - h.entry_price) / h.entry_price * 100) : 0;
      html += `<tr>
        <td><strong>${h.symbol}</strong><br><span class="dim">${h.name}</span></td>
        <td>${fmtPrice(h.entry_price)}</td>
        <td>${h.sold_price ? fmtPrice(h.sold_price) : fmtPrice(h.current_price)}</td>
        <td class="${pnlClass(pnl)}"><strong>${pnlSign(pnl)}${fmt(pnl)}%</strong></td>
        <td>${h.entry_date || '–'}</td>
        <td>${h.sold_date || '–'}</td>
        <td><span class="badge badge-sold">${h.status}</span></td>
      </tr>`;
    });
    html += '</tbody></table>';
    soldDiv.innerHTML = html;
  } else {
    soldDiv.innerHTML = '<div class="dim" style="padding:12px">Keine verkauften Coins</div>';
  }

  // Watchlist
  const wlDiv = $('#watchlistSection');
  const seen = new Set();
  const wlUnique = watchlist.filter(h => { if(seen.has(h.symbol)) return false; seen.add(h.symbol); return true; });
  if(wlUnique.length) {
    let html = '<table><thead><tr><th>Coin</th><th>Chain</th><th>Preis</th><th>Entry</th></tr></thead><tbody>';
    wlUnique.forEach(h => {
      html += `<tr><td><strong>${h.symbol}</strong> ${h.name}</td><td>${h.chain||'–'}</td><td>${h.current_price ? fmtPrice(h.current_price) : '–'}</td><td>${h.entry_price > 0 ? fmtPrice(h.entry_price) : '–'}</td></tr>`;
    });
    html += '</tbody></table>';
    wlDiv.innerHTML = html;
  } else {
    wlDiv.innerHTML = '<div class="dim">Keine Coins auf der Watchlist</div>';
  }

  // Scanner (paginated — Top 5 visible, swipe for more)
  const scanDiv = $('#scannerCards');
  const scanCoins = (data.scanner_coins||[]).sort((a,b) => (b.score||0)-(a.score||0));
  const PAGE_SIZE = 5;
  if(scanCoins.length){
    const totalPages = Math.ceil(scanCoins.length / PAGE_SIZE);
    let curPage = 0;
    function renderScannerCard(c){
      const badgeCls = 'badge-' + (c.result||'').replace(/-/g,'');
      const scoreColor = c.score >= 50 ? 'var(--green)' : c.score >= 30 ? 'var(--orange)' : 'var(--red)';
      return `
      <div class="scanner-card" onclick="this.classList.toggle('open')">
        <div class="scanner-header">
          <div class="scanner-left">
            <span class="scanner-symbol">${c.symbol}</span>
            <span class="scanner-narrative">${c.narrative||c.name||''}</span>
          </div>
          <div class="scanner-right">
            <span class="badge ${badgeCls}">${c.result||'–'}</span>
            <span class="scanner-score" style="color:${scoreColor}">${c.score||0}</span>
            <span class="scanner-arrow">▼</span>
          </div>
        </div>
        <div class="scanner-details">
          <div class="scanner-row"><span class="label">Name</span><span class="val">${c.name||'–'}</span></div>
          <div class="scanner-row"><span class="label">Chain</span><span class="val">${c.chain||'–'}</span></div>
          <div class="scanner-row"><span class="label">Market Cap</span><span class="val">${fmtCompact(c.market_cap)}</span></div>
          <div class="scanner-row"><span class="label">Liquidity</span><span class="val">${fmtCompact(c.liquidity)}</span></div>
          <div class="scanner-row"><span class="label">Volume 24h</span><span class="val">${fmtCompact(c.volume_24h)}</span></div>
          <div class="scanner-row"><span class="label">Score</span><span class="val" style="color:${scoreColor}">${c.score||0}/100</span></div>
          <div class="scanner-row"><span class="label">Gescannt</span><span class="val dim">${c.scanned_at||'–'}</span></div>
          <div class="scanner-reason">${c.reason||'Keine Details'}</div>
        </div>
      </div>`;
    }
    function renderScannerPage(){
      const start = curPage * PAGE_SIZE;
      const pageCoins = scanCoins.slice(start, start + PAGE_SIZE);
      const cardsHtml = pageCoins.map(renderScannerCard).join('');
      scanDiv.innerHTML = `
        <div id="scannerPageContent">${cardsHtml}</div>
        ${totalPages > 1 ? `
        <div class="scanner-pagination">
          <button id="scanPrev" ${curPage===0?'disabled':''}>◀ Zurück</button>
          <span class="page-info">${curPage+1} / ${totalPages} (${scanCoins.length} Coins)</span>
          <button id="scanNext" ${curPage>=totalPages-1?'disabled':''}>Weiter ▶</button>
        </div>` : ''}
      `;
      if(totalPages > 1){
        $('#scanPrev').onclick = () => { if(curPage>0){curPage--;renderScannerPage()} };
        $('#scanNext').onclick = () => { if(curPage<totalPages-1){curPage++;renderScannerPage()} };
      }
    }
    renderScannerPage();

    // Swipe support for mobile
    let touchStartX = 0;
    scanDiv.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, {passive:true});
    scanDiv.addEventListener('touchend', e => {
      const diff = touchStartX - e.changedTouches[0].clientX;
      if(Math.abs(diff) > 60){
        if(diff > 0 && curPage < totalPages-1){ curPage++; renderScannerPage(); }
        else if(diff < 0 && curPage > 0){ curPage--; renderScannerPage(); }
      }
    }, {passive:true});
  } else {
    scanDiv.innerHTML = '<div class="card"><div class="dim">Keine Scanner-Ergebnisse</div></div>';
  }

  // Chart
  const portHist = data.portfolio_history || [];
  const chartData = portHist.map(p => {
    const raw = p.recorded_at.replace(' ','T');
    const ts = new Date(raw.includes('Z') || raw.includes('+') ? raw : raw+'Z').getTime();
    return { t: ts, total: p.portfolio_value };
  }).filter(d => !isNaN(d.t) && d.total > 0);

  if(chartData.length > 1) {
    new Chart($('#priceChart'), {
      type: 'line',
      data: {
        labels: chartData.map(d => new Date(d.t).toLocaleString('de-DE', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})),
        datasets: [{
          label: 'Portfolio Wert ($)',
          data: chartData.map(d => d.total),
          borderColor: '#f7931a',
          backgroundColor: 'rgba(247,147,26,0.1)',
          fill: true, tension: 0.3, pointRadius: 3
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#e0e0e0' } } },
        scales: {
          x: { ticks: { color: '#888', maxTicksLimit: 8 }, grid: { color: '#2a2a3a' } },
          y: { ticks: { color: '#888', callback: v => '$'+v.toLocaleString() }, grid: { color: '#2a2a3a' }, beginAtZero: false }
        }
      }
    });
  } else {
    $('#priceChart').parentElement.innerHTML = '<div class="dim" style="padding:40px;text-align:center">Chart wird mit jedem Update genauer</div>';
  }

  // Lessons (collapsed dropdown)
  const lDiv = $('#lessonsSection');
  const lessonsData = data.lessons||[];
  $('#lessonsCount').textContent = lessonsData.length ? `(${lessonsData.length})` : '';
  if(lessonsData.length) {
    lDiv.innerHTML = '<div style="padding:0 16px 14px">' + lessonsData.map(l => `
      <div class="lesson">
        <span class="code">${l.code}</span><strong>${l.title}</strong>
        <div class="dim">${l.description||''}</div>
        <div class="rule">→ ${l.rule}</div>
      </div>
    `).join('') + '</div>';
  } else {
    lDiv.innerHTML = '<div class="dim" style="padding:16px">Keine Lessons</div>';
  }
}
init();
</script>
</body>
</html>
