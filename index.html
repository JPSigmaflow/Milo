<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JC INV PORTFOLIO</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#14141f;--border:#2a2a3a;--text:#e0e0e0;--dim:#888;--green:#00e676;--red:#ff5252;--orange:#f7931a;--blue:#64b5f6;--header-bg:#1a1a2e}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;padding:12px;max-width:1200px;margin:0 auto;line-height:1.5}
h1{color:#ffffff;font-size:1.8rem;margin-bottom:4px;font-weight:700;letter-spacing:2px}
h2{color:#ffffff;font-size:1.2rem;margin:24px 0 12px;border-bottom:1px solid var(--border);padding-bottom:6px;font-weight:600}
.sub{color:var(--dim);font-size:.85rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.stat .label{color:var(--dim);font-size:.75rem;text-transform:uppercase;letter-spacing:1px}
.stat .value{font-size:1.5rem;font-weight:700;margin-top:4px}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{background:var(--header-bg);color:#ffffff;text-align:left;padding:8px 6px;position:sticky;top:0}
td{padding:7px 6px;border-bottom:1px solid var(--border)}
tr:hover{background:rgba(255,255,255,.03)}
.green{color:var(--green)}.red{color:var(--red)}.dim{color:var(--dim)}
.badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.7rem;font-weight:600;text-transform:uppercase}
.badge-active{background:rgba(0,230,118,.15);color:var(--green)}
.badge-watchlist{background:rgba(100,181,246,.15);color:var(--blue)}
.badge-sold{background:rgba(255,82,82,.15);color:var(--red)}
.badge-nogo{background:rgba(255,82,82,.15);color:var(--red)}
.badge-deepdive{background:rgba(247,147,26,.15);color:var(--orange)}
.badge-setup{background:rgba(0,230,118,.15);color:var(--green)}
.badge-bought{background:rgba(0,230,118,.15);color:var(--green)}
.badge-rejected{background:rgba(255,82,82,.12);color:var(--red)}
.overflow-x{overflow-x:auto}
.chart-wrap{height:300px;position:relative}
.lesson{margin-bottom:12px;padding:12px;background:rgba(247,147,26,.05);border-left:3px solid var(--orange);border-radius:0 8px 8px 0}
.lesson .code{color:var(--orange);font-weight:700;margin-right:8px}
.lesson .rule{color:var(--green);font-size:.82rem;margin-top:4px}
#loading{text-align:center;padding:60px;color:var(--dim);font-size:1.2rem}
/* Accordion Scanner Cards */
.scanner-card{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;overflow:hidden}
.scanner-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;user-select:none;gap:10px}
.scanner-header:hover{background:rgba(255,255,255,.03)}
.scanner-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.scanner-symbol{font-weight:700;font-size:1.1rem;white-space:nowrap}
.scanner-narrative{color:var(--dim);font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.scanner-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.scanner-score{font-weight:700;font-size:1rem;background:var(--header-bg);padding:3px 10px;border-radius:8px}
.scanner-arrow{color:var(--dim);font-size:.8rem;transition:transform .2s}
.scanner-card.open .scanner-arrow{transform:rotate(180deg)}
.scanner-details{display:none;padding:0 16px 14px;border-top:1px solid var(--border)}
.scanner-card.open .scanner-details{display:block}
.scanner-row{display:flex;justify-content:space-between;padding:6px 0;font-size:.85rem}
.scanner-row .label{color:var(--dim)}
.scanner-row .val{font-weight:600}
.scanner-reason{margin-top:8px;padding:10px;background:rgba(255,255,255,.03);border-radius:8px;font-size:.83rem;line-height:1.5;color:var(--dim)}
@media(max-width:600px){h1{font-size:1.3rem}h2{font-size:1rem}table{font-size:.68rem}td,th{padding:4px 3px}.stat .value{font-size:1rem}.stat .label{font-size:.65rem}.stats{gap:8px}.stat{padding:10px}.scanner-symbol{font-size:.95rem}.scanner-narrative{font-size:.7rem}.scanner-score{font-size:.85rem;padding:2px 8px}.scanner-row{font-size:.78rem}.scanner-reason{font-size:.75rem}.lesson{padding:10px;font-size:.82rem}.lesson .rule{font-size:.75rem}}
</style>
</head>
<body>
<div id="loading">‚è≥ Loading data...</div>
<div id="app" style="display:none">

<header style="margin-bottom:20px">
<h1>JC INV PORTFOLIO</h1>
<div class="sub" id="lastUpdate"></div>
</header>

<div class="stats" id="statsGrid"></div>

<h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M3 9h18M9 3v18"/></svg>Portfolio Holdings</h2>
<div class="card overflow-x"><table id="holdingsTable"><thead><tr>
<th>Coin</th><th>Menge</th><th>Entry</th><th>Aktuell</th><th>Wert</th><th>P&L%</th><th>Status</th>
</tr></thead><tbody></tbody></table></div>

<h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="1" fill="#fff"/></svg>Watchlist</h2>
<div class="card overflow-x" id="watchlistSection"></div>

<h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" style="vertical-align:-3px;margin-right:6px"><circle cx="10" cy="10" r="7"/><line x1="15" y1="15" x2="21" y2="21"/></svg>Scanner Ergebnisse</h2>
<div id="scannerCards"></div>

<h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><polyline points="3,17 9,11 13,15 21,7"/><polyline points="16,7 21,7 21,12"/></svg>Portfolio Entwicklung</h2>
<div class="card chart-wrap"><canvas id="priceChart"></canvas></div>

<h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>Lessons Learned</h2>
<div class="card" id="lessonsSection"></div>

</div>

<script>
const $ = s => document.querySelector(s);
const fmt = (n,d=2) => n!=null ? Number(n).toLocaleString('de-DE',{minimumFractionDigits:d,maximumFractionDigits:d}) : '‚Äì';
const fmtVal = n => n!=null ? '$' + Number(n).toLocaleString('de-DE',{minimumFractionDigits:0,maximumFractionDigits:0}) : '‚Äì';
const fmtPrice = n => n!=null ? '$' + (n < 0.01 ? Number(n).toFixed(5) : Number(n).toLocaleString('de-DE',{minimumFractionDigits:3,maximumFractionDigits:3})) : '‚Äì';
const fmtUsd = n => '$' + fmt(n);
const fmtCompact = n => {
  if(!n) return '‚Äì';
  if(n>=1e9) return '$'+fmt(n/1e9,1)+'B';
  if(n>=1e6) return '$'+fmt(n/1e6,1)+'M';
  if(n>=1e3) return '$'+fmt(n/1e3,1)+'K';
  return '$'+fmt(n);
};
const pnlClass = v => v >= 0 ? 'green' : 'red';
const pnlSign = v => v >= 0 ? '+' : '';

async function init() {
  let data;
  try {
    const r = await fetch('https://raw.githubusercontent.com/JPSigmaflow/Milo/main/data.json?t=' + Date.now());
    data = await r.json();
  } catch(e) {
    $('#loading').textContent = '‚ùå Could not load data.json';
    return;
  }
  $('#loading').style.display = 'none';
  $('#app').style.display = 'block';

  // Header
  const d = new Date(data.exported_at);
  $('#lastUpdate').textContent = `Letzte Aktualisierung: ${d.toLocaleDateString('de-DE')} ${d.toLocaleTimeString('de-DE')} UTC`;

  // Active holdings
  const active = data.holdings.filter(h => h.status === 'active');
  const watchlistHoldings = data.holdings.filter(h => h.status === 'watchlist');

  // Stats
  let totalValue = 0, totalInvested = 0;
  active.forEach(h => {
    const val = h.amount * (h.current_price || 0);
    const inv = h.amount * h.entry_price;
    totalValue += val;
    totalInvested += inv;
  });
  const totalPnl = totalInvested > 0 ? ((totalValue - totalInvested) / totalInvested * 100) : 0;
  const totalPnlAbs = totalValue - totalInvested;

  $('#statsGrid').innerHTML = `
    <div class="stat"><div class="label">Portfolio Wert</div><div class="value">${fmtVal(totalValue)}</div></div>
    <div class="stat"><div class="label">Investiert</div><div class="value">${fmtVal(totalInvested)}</div></div>
    <div class="stat"><div class="label">P&L</div><div class="value ${pnlClass(totalPnlAbs)}">${pnlSign(totalPnlAbs)}${fmtVal(totalPnlAbs)} (${pnlSign(totalPnl)}${fmt(totalPnl)}%)</div></div>
    <div class="stat"><div class="label">USDT Frei</div><div class="value">${fmtVal(data.usdt_free)}</div></div>
    <div class="stat"><div class="label">Positionen</div><div class="value">${active.length}</div></div>
  `;

  // Holdings table
  const tbody = $('#holdingsTable tbody');
  active.forEach(h => {
    const val = h.amount * (h.current_price || 0);
    const pnl = h.entry_price > 0 ? ((h.current_price - h.entry_price) / h.entry_price * 100) : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${h.symbol}</strong><br><span class="dim">${h.name}</span></td>
      <td>${fmt(h.amount,0)}</td>
      <td>${fmtPrice(h.entry_price)}</td>
      <td>${fmtPrice(h.current_price)}</td>
      <td>${fmtVal(val)}</td>
      <td class="${pnlClass(pnl)}"><strong>${pnlSign(pnl)}${fmt(pnl)}%</strong></td>
      <td><span class="badge badge-${h.status}">${h.status}</span></td>
    `;
    tbody.appendChild(tr);
  });

  // Sold holdings (FHE)
  const sold = data.holdings.filter(h => h.status === 'sold' || (h.sold_price && h.sold_price > 0));
  if (sold.length) {
    sold.forEach(h => {
      const pnl = h.entry_price > 0 && h.sold_price ? ((h.sold_price - h.entry_price) / h.entry_price * 100) : 0;
      const tr = document.createElement('tr');
      tr.style.opacity = '0.6';
      tr.innerHTML = `
        <td><strong>${h.symbol}</strong><br><span class="dim">${h.name}</span></td>
        <td>${fmt(h.amount,0)}</td>
        <td>${fmtPrice(h.entry_price)}</td>
        <td>${h.sold_price ? fmtPrice(h.sold_price) : '‚Äì'}</td>
        <td>‚Äì</td>
        <td class="${pnlClass(pnl)}"><strong>${pnlSign(pnl)}${fmt(pnl)}%</strong></td>
        <td><span class="badge badge-sold">${h.sold_date ? 'sold '+h.sold_date : h.status}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Watchlist
  const wlDiv = $('#watchlistSection');
  const allWl = [...watchlistHoldings, ...data.holdings.filter(h => h.status === 'watchlist' && h.amount === 0)];
  // Deduplicate
  const seen = new Set();
  const wlUnique = allWl.filter(h => { if(seen.has(h.symbol)) return false; seen.add(h.symbol); return true; });
  
  if (wlUnique.length) {
    let html = '<table><thead><tr><th>Coin</th><th>Chain</th><th>Preis</th><th>Entry</th></tr></thead><tbody>';
    wlUnique.forEach(h => {
      html += `<tr><td><strong>${h.symbol}</strong> ${h.name}</td><td>${h.chain||'‚Äì'}</td><td>${h.current_price ? fmtPrice(h.current_price) : '‚Äì'}</td><td>${h.entry_price > 0 ? fmtPrice(h.entry_price) : '‚Äì'}</td></tr>`;
    });
    html += '</tbody></table>';
    wlDiv.innerHTML = html;
  } else {
    wlDiv.innerHTML = '<div class="dim">Keine Coins auf der Watchlist</div>';
  }

  // Scanner (Accordion Cards)
  const scanDiv = $('#scannerCards');
  const scanCoins = data.scanner_coins||[];
  if(scanCoins.length){
    scanDiv.innerHTML = scanCoins.map(c => {
      const badgeCls = 'badge-' + (c.result||'').replace('-','');
      const scoreColor = c.score >= 50 ? 'var(--green)' : c.score >= 30 ? 'var(--orange)' : 'var(--red)';
      return `
      <div class="scanner-card" onclick="this.classList.toggle('open')">
        <div class="scanner-header">
          <div class="scanner-left">
            <span class="scanner-symbol">${c.symbol}</span>
            <span class="scanner-narrative">${c.narrative||c.name||''}</span>
          </div>
          <div class="scanner-right">
            <span class="badge ${badgeCls}">${c.result||'‚Äì'}</span>
            <span class="scanner-score" style="color:${scoreColor}">${c.score||0}</span>
            <span class="scanner-arrow">‚ñº</span>
          </div>
        </div>
        <div class="scanner-details">
          <div class="scanner-row"><span class="label">Name</span><span class="val">${c.name||'‚Äì'}</span></div>
          <div class="scanner-row"><span class="label">Chain</span><span class="val">${c.chain||'‚Äì'}</span></div>
          <div class="scanner-row"><span class="label">Market Cap</span><span class="val">${fmtCompact(c.market_cap)}</span></div>
          <div class="scanner-row"><span class="label">Liquidity</span><span class="val">${fmtCompact(c.liquidity)}</span></div>
          <div class="scanner-row"><span class="label">Volume 24h</span><span class="val">${fmtCompact(c.volume_24h)}</span></div>
          <div class="scanner-row"><span class="label">Score</span><span class="val" style="color:${scoreColor}">${c.score||0}/100</span></div>
          <div class="scanner-row"><span class="label">Gescannt</span><span class="val dim">${c.scanned_at||'‚Äì'}</span></div>
          <div class="scanner-reason">${c.reason||'Keine Details'}</div>
        </div>
      </div>`;
    }).join('');
  } else {
    scanDiv.innerHTML = '<div class="card"><div class="dim">Keine Scanner-Ergebnisse</div></div>';
  }

  // Chart - use pre-calculated portfolio_history from export
  const portHist = data.portfolio_history || [];
  const chartData = portHist.map(p => {
    const raw = p.recorded_at.replace(' ','T');
    const ts = new Date(raw.includes('Z') || raw.includes('+') ? raw : raw+'Z').getTime();
    return { t: ts, total: p.portfolio_value };
  }).filter(d => !isNaN(d.t) && d.total > 0);

  if (chartData.length > 1) {
    new Chart($('#priceChart'), {
      type: 'line',
      data: {
        labels: chartData.map(d => {
          const dt = new Date(d.t);
          return dt.toLocaleString('de-DE', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
        }),
        datasets: [{
          label: 'Portfolio Wert ($)',
          data: chartData.map(d => d.total),
          borderColor: '#f7931a',
          backgroundColor: 'rgba(247,147,26,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#e0e0e0' } } },
        scales: {
          x: { ticks: { color: '#888', maxTicksLimit: 8 }, grid: { color: '#2a2a3a' } },
          y: { ticks: { color: '#888', callback: v => '$'+v.toLocaleString() }, grid: { color: '#2a2a3a' }, beginAtZero: false }
        }
      }
    });
  } else {
    $('#priceChart').parentElement.innerHTML = '<div class="dim" style="padding:40px;text-align:center">üìä Chart wird mit jedem Update genauer (alle 2h)</div>';
  }

  // Lessons
  const lDiv = $('#lessonsSection');
  if (data.lessons && data.lessons.length) {
    lDiv.innerHTML = data.lessons.map(l => `
      <div class="lesson">
        <span class="code">${l.code}</span><strong>${l.title}</strong>
        <div class="dim">${l.description||''}</div>
        <div class="rule">‚Üí ${l.rule}</div>
      </div>
    `).join('');
  } else {
    lDiv.innerHTML = '<div class="dim">Keine Lessons</div>';
  }
}

init();
</script>
</body>
</html>
